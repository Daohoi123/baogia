<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Tạo Báo Giá Tự Động</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/colresizable@1.6.0/colResizable-1.6.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f2f5;
        }
        .quotation-paper {
            background: white;
            padding: 1.5rem; /* Reduced padding for A4 fit */
            margin: 1rem auto;
            max-width: 800px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 8px;
        }
        .control-panel {
            background: white;
            padding: 2rem;
            margin: 2rem auto;
            max-width: 1200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border-radius: 8px;
        }
        h1, h2, h3 {
            font-weight: 700;
            color: #1a202c;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        /* No table-layout fixed for overflow resize mode */
        th, td {
            border: 1px solid #e2e8f0;
            padding: 6px;
            text-align: center;
            font-size: 0.85rem;
            vertical-align: middle;
            word-wrap: break-word;
        }
        th {
            background-color: #f7fafc;
            font-weight: 500;
        }
        .total-row td {
            font-weight: 700;
            text-align: right;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            transition: border-color 0.2s;
            box-sizing: border-box;
            text-align: center;
        }
        input[readonly] {
            background-color: #f7fafc;
            cursor: not-allowed;
        }
        #input-row {
            background-color: #f0f9ff;
        }
        #input-row input, #input-row select {
             font-size: 0.85rem;
             padding: 6px;
        }
        select#item-unit {
            text-align: center;
            -moz-text-align-last: center;
            text-align-last: center;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4a5568;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
        .btn {
            padding: 10px 16px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
        }
        .btn-sm { padding: 6px 12px; font-size: 0.85rem; }
        .btn-primary { background-color: #2d3748; color: white; }
        .btn-primary:hover { background-color: #1a202c; }
        .btn-secondary { background-color: #4caf50; color: white; }
        .btn-secondary:hover { background-color: #45a049; }
        .btn-danger { background-color: #f44336; color: white; }
        .btn-danger:hover { background-color: #da190b; }
        .btn-warning { background-color: #fbbf24; color: #374151; }
        .btn-warning:hover { background-color: #f59e0b; }
        .hidden { display: none; }
        
        .JCLRgrip { height: 20px; width: 7px; background-color: #e2e8f0; margin-left: -4px; z-index: 5; }
        .JCLRgrip:hover { background-color: #a0aec0; }

        .action-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
            padding: 4px;
            display: flex;
            flex-direction: row;
            gap: 4px;
        }
        .stt-cell { cursor: pointer; position: relative; font-weight: 500; }
        .stt-cell:hover { background-color: #edf2f7; }
        
        #helper-body tr {
            cursor: grab;
        }
        #helper-body tr:active {
            cursor: grabbing;
        }
        .sortable-ghost {
            opacity: 0.4;
            background: #cce7ff;
        }

        .editable-text {
            outline: 1px dashed #fbbf24;
            background-color: #fefce8;
            cursor: text;
        }
        .editable-text:focus {
             outline: 2px solid #f59e0b;
        }

        @media print {
            body { background-color: white; }
            .control-panel, .generation-controls, .output-actions, .action-menu { display: none !important; }
            #quotation-output { display: block !important; }
            .quotation-paper {
                margin: 0;
                max-width: 100%;
                box-shadow: none;
                border-radius: 0;
                padding: 0;
            }
        }
    </style>
</head>
<body class="p-4">

    <!-- Datalists for input history -->
    <datalist id="item-name-history"></datalist>
    <datalist id="item-price-history"></datalist>

    <div class="control-panel">
        <h2 class="text-2xl mb-6 text-center">Bảng Giá</h2>
        <div class="overflow-x-auto">
            <table id="helper-table">
                <thead>
                    <tr>
                        <th style="width: 4%;">STT</th>
                        <th style="width: 14%;">Hạng mục</th>
                        <th style="width: 7%;">Ngang (cm)</th>
                        <th style="width: 7%;">Cao (cm)</th>
                        <th style="width: 7%;">Số lượng</th>
                        <th style="width: 7%;">m2</th>
                        <th style="width: 9%;">ĐVT</th>
                        <th style="width: 9%;">Đơn giá</th>
                        <th style="width: 9%;">Thành tiền</th>
                        <th style="width: 20%;">Quy cách</th>
                        <th style="width: 7%;">VAT (%)</th>
                    </tr>
                </thead>
                <tbody id="helper-body"></tbody>
                <tfoot>
                    <!-- MODIFIED: Totals row moved inside the table tfoot -->
                    <tr>
                        <td colspan="11" class="border-0 p-2">
                            <div id="totals-display" class="relative z-10 flex justify-end items-center space-x-8 p-4 bg-gray-100 rounded-lg">
                                <div class="text-right">
                                    <span class="text-sm font-medium text-gray-600">TỔNG TIỀN:</span>
                                    <span id="total-subtotal" class="text-lg font-bold text-gray-800">0</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-medium text-gray-600">VAT:</span>
                                    <span id="total-vat" class="text-lg font-bold text-gray-800">0</span>
                                </div>
                                <div class="text-right">
                                    <span class="text-sm font-medium text-gray-600">TỔNG CỘNG:</span>
                                    <span id="total-grandtotal" class="text-xl font-bold text-red-600">0</span>
                                </div>
                            </div>
                        </td>
                    </tr>
                    <!-- Input row remains the last row -->
                    <tr id="input-row">
                        <td id="next-stt" class="text-center font-semibold">1</td>
                        <td><input type="text" id="item-name" placeholder="Hạng mục" list="item-name-history"></td>
                        <td><input type="number" id="item-width" placeholder="Ngang" value="0"></td>
                        <td><input type="number" id="item-height" placeholder="Cao" value="0"></td>
                        <td><input type="number" id="item-quantity" placeholder="Số lượng" value="1"></td>
                        <td id="calculated-m2" class="text-center font-medium">0.0000</td>
                        <td>
                            <select id="item-unit" class="text-center">
                                <option value="m2">m2</option>
                                <option value="tấm">tấm</option>
                                <option value="cái">cái</option>
                                <option value="bộ">bộ</option>
                                <option value="cuộn">cuộn</option>
                                <option value="gói">gói</option>
                                <option value="khác">khác</option>
                            </select>
                            <input type="text" id="item-unit-other" class="mt-1 hidden" placeholder="Nhập ĐVT khác">
                        </td>
                        <td><input type="text" id="item-unit-price" placeholder="Đơn giá" value="0" list="item-price-history"></td>
                        <!-- MODIFIED: Thành tiền is now an input field -->
                        <td><input type="text" id="item-total-price" placeholder="Thành tiền" value="0" readonly></td>
                        <td><input type="text" id="item-spec" placeholder="Quy cách"></td>
                        <td><input type="number" id="item-vat" placeholder="VAT" value="0"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <div id="generation-controls" class="control-panel">
         <h2 class="text-2xl mb-6 text-center">Thông Tin Báo Giá</h2>
         <div class="grid md:grid-cols-2 gap-6">
            <div>
                <label for="final-quote-number" class="block font-medium mb-2 text-left">Số Báo Giá</label>
                <div class="flex items-center">
                    <input type="text" id="final-quote-number" value="0218" class="w-24 text-center p-2 border rounded-l">
                    <span class="px-4 py-2 bg-gray-200 border border-l-0 rounded-r">-25/BG-ĐN</span>
                </div>
            </div>
         </div>
         <div class="text-center mt-8">
            <button id="generate-quote-btn" class="btn btn-secondary text-lg px-8 py-3">Cập Nhật Báo Giá</button>
         </div>
    </div>
    
    <div id="quotation-output" class="hidden">
        <div class="output-actions text-center my-8 space-x-4">
            <button id="download-pdf-btn" class="btn btn-primary">Tải Báo Giá</button>
            <button id="toggle-edit-mode-btn" class="btn btn-warning">Chỉnh Sửa</button>
        </div>
        <div class="quotation-paper" id="quotation-paper">
            <!-- Header -->
            <div class="flex justify-between items-center mb-4">
                <div class="w-1/5">
                    <img src="https://res.cloudinary.com/dzfuqyqoq/image/upload/v1753957465/logo_NV_xmvkd7.png" alt="Logo Công ty" style="max-width: 120px;">
                </div>
                <div class="w-4/5 text-right">
                    <h2 class="text-xl font-bold manual-edit">CÔNG TY TNHH ĐẦU TƯ TỔNG HỢP NHẤT VIỆT</h2>
                    <p class="text-sm manual-edit">Văn phòng: 62/18 Trương Công Định, Phường Tân Bình, Thành phố Hồ Chí Minh</p>
                    <p class="text-sm manual-edit">Mã số thuế: 0318801611</p>
                    <p class="text-sm manual-edit">ĐT: 0908.136.666 ( Mr Công)</p>
                </div>
            </div>

            <!-- Title and Info -->
            <div class="flex justify-between items-start mb-4">
                <div></div>
                <div class="text-center">
                    <p class="manual-edit">TP. Hồ Chí Minh, <span id="quote-date"></span></p>
                    <p id="quote-number-display" class="font-semibold manual-edit"></p>
                </div>
            </div>
            <h1 class="text-2xl font-bold text-center mb-2 manual-edit">BÁO GIÁ</h1>
            <p class="text-center mb-4 text-sm manual-edit">(V/v: In ấn)</p>

            <!-- Customer Info and Intro -->
            <div class="mb-4 text-left">
                <!-- MODIFIED: Bolding only the company name -->
                <p class="mt-2 manual-edit"><span class="font-bold">Công Ty TNHH Đầu Tư Tổng hợp Nhất Việt</span> kính chào Quý khách. Cảm ơn Quý khách đã ủng hộ Nhất Việt trong thời gian qua. Theo yêu cầu của Quý khách, chúng tôi xin gởi bảng báo giá như sau:</p>
            </div>

            <!-- Quotation Table -->
            <!-- MODIFIED: Table header updated -->
            <table id="main-quote-table" class="mb-4">
                <thead>
                    <tr>
                        <th rowspan="2" class="w-12">STT</th>
                        <th rowspan="2">Hạng mục</th>
                        <th colspan="2">Kích Thước (cm)</th>
                        <th rowspan="2" style="width: 25%;">Quy cách</th>
                        <th rowspan="2">ĐVT</th>
                        <th rowspan="2">Đơn giá</th>
                        <th rowspan="2">Số lượng</th>
                        <th rowspan="2">Thành Tiền</th>
                    </tr>
                    <tr>
                        <th>Ngang</th>
                        <th>Cao</th>
                    </tr>
                </thead>
                <tbody id="main-quote-body"></tbody>
                <tfoot>
                    <!-- MODIFIED: Colspan updated -->
                    <tr class="total-row">
                        <td colspan="8">TỔNG TIỀN CHƯA BAO GỒM VAT</td>
                        <td id="subtotal-quote" class="text-right">0</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="8">VAT</td>
                        <td id="vat-quote" class="text-right">0</td>
                    </tr>
                    <tr class="total-row">
                        <td colspan="8">TỔNG TIỀN BAO GỒM VAT</td>
                        <td id="grandtotal-quote" class="text-right">0</td>
                    </tr>
                </tfoot>
            </table>

            <!-- New Footer Section -->
            <div class="text-left text-xs mt-4 space-y-2">
                <div>
                    <h3 class="font-bold manual-edit">I/ Thanh toán</h3>
                    <p class="manual-edit">* Phương thức thanh toán: tiền mặt hoặc chuyển khoản</p>
                    <p class="manual-edit">* Bên Mua thanh toán làm 2 lần:</p>
                    <p class="ml-4 manual-edit">Lần 01: 50% sau khi đặt hàng</p>
                    <p class="ml-4 manual-edit">Lần 02: 50% còn lại sau khi nhận đủ hàng</p>
                </div>
                <div>
                    <h3 class="font-bold manual-edit">II/ THÔNG TIN CHUYỂN KHOẢN</h3>
                    <p class="manual-edit">1. Tài khoản công ty: CÔNG TY TNHH ĐẦU TƯ TỔNG HỢP NHẤT VIỆT</p>
                    <p class="ml-4 manual-edit">STK ACB: 80161188</p>
                    <p class="ml-4 manual-edit">Ngân Hàng ACB, Quận Tân Bình, TPHCM</p>
                </div>
                <div>
                    <h3 class="font-bold manual-edit">II/ Giao nhận</h3>
                    <p class="manual-edit">* Thỏa thuận</p>
                </div>
                <div>
                    <h3 class="font-bold manual-edit">III/ Giá trị bảng báo giá:</h3>
                    <p class="manual-edit">Có giá trị 15 ngày kể từ ngày báo giá.</p>
                </div>
                <div class="flex justify-between items-start pt-8">
                    <div class="text-center w-2/5">
                        <p class="font-bold manual-edit">Xác nhận của khách hàng</p>
                         <p class="mt-20">&nbsp;</p> <!-- Signature space -->
                    </div>
                    <div class="text-center w-2/5">
                        <p class="manual-edit">Đơn vị thiết kế/ In ấn/ thi công</p>
                        <p class="font-bold manual-edit">CÔNG TY TNHH QUẢNG CÁO TRUYỀN THÔNG NHẤT VIỆT</p>
                        <p class="mt-12 font-bold manual-edit">Phòng kinh doanh</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
$(document).ready(function() {
    // --- STATE MANAGEMENT ---
    let helperItems = [];
    let editingItemId = null;

    // --- DOM ELEMENT REFERENCES ---
    const quoteDateEl = document.getElementById('quote-date');
    const inputRowEl = document.getElementById('input-row');
    const inputRow = {
        stt: document.getElementById('next-stt'),
        name: document.getElementById('item-name'),
        width: document.getElementById('item-width'),
        height: document.getElementById('item-height'),
        m2: document.getElementById('calculated-m2'),
        quantity: document.getElementById('item-quantity'),
        unit: document.getElementById('item-unit'),
        unitOther: document.getElementById('item-unit-other'),
        unitPrice: document.getElementById('item-unit-price'),
        price: document.getElementById('item-total-price'), // MODIFIED: Reference to the new input
        spec: document.getElementById('item-spec'),
        vat: document.getElementById('item-vat'),
    };
    const helperBody = document.getElementById('helper-body');
    const generateQuoteBtn = document.getElementById('generate-quote-btn');
    const quotationOutput = document.getElementById('quotation-output');
    const generationControls = document.getElementById('generation-controls');
    const downloadPdfBtn = document.getElementById('download-pdf-btn');
    const toggleEditModeBtn = document.getElementById('toggle-edit-mode-btn');
    const totalsDisplay = {
        subtotal: document.getElementById('total-subtotal'),
        vat: document.getElementById('total-vat'),
        grandtotal: document.getElementById('total-grandtotal'),
    };
     const quoteTotalsDisplay = {
        subtotal: document.getElementById('subtotal-quote'),
        vat: document.getElementById('vat-quote'),
        grandtotal: document.getElementById('grandtotal-quote'),
    };

    // --- INITIALIZATION ---
    function initialize() {
        const today = new Date();
        const day = String(today.getDate()).padStart(2, '0');
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const year = today.getFullYear();
        if(quoteDateEl) quoteDateEl.textContent = `${day}/${month}/${year}`;

        function adjustGripHeight() {
            const headerHeight = $("#helper-table > thead").outerHeight();
            if (headerHeight > 0) {
                 $(".JCLRgrip").css('height', headerHeight + 'px');
            }
        }

        $("#helper-table").colResizable({ 
            liveDrag: true,
            resizeMode: 'overflow',
            onResize: adjustGripHeight
        });
        
        setTimeout(adjustGripHeight, 100);
        
        new Sortable(helperBody, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function (evt) {
                const item = helperItems.splice(evt.oldIndex, 1)[0];
                helperItems.splice(evt.newIndex, 0, item);
                updateSTT();
                renderHelperTable();
                calculateAndDisplayTotals();
            },
        });

        // --- MODIFIED: Specific event listeners for bidirectional calculation ---
        inputRow.unitPrice.addEventListener('input', calculateTotalFromInputs);
        inputRow.quantity.addEventListener('input', calculateTotalFromInputs);
        inputRow.width.addEventListener('input', calculateTotalFromInputs);
        inputRow.height.addEventListener('input', calculateTotalFromInputs);
        inputRow.price.addEventListener('input', calculateUnitFromTotal); // Listener for Thành tiền
        inputRow.unit.addEventListener('change', handleUnitChange);
        
        generateQuoteBtn.addEventListener('click', generateQuote);
        downloadPdfBtn.addEventListener('click', downloadQuoteAsPDF);
        toggleEditModeBtn.addEventListener('click', toggleQuoteEditMode);
        
        inputRowEl.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleAddOrUpdateItem();
            }
        });
        
        helperBody.addEventListener('click', function(event) {
            if (event.target.classList.contains('stt-cell')) {
                const itemId = parseInt(event.target.dataset.id);
                showActionMenu(event.target, itemId);
            }
        });

        document.addEventListener('click', function(event) {
            if (!event.target.closest('.action-menu') && !event.target.classList.contains('stt-cell')) {
                closeActionMenu();
            }
        });
        
        resetInputRow(true);
    }

    function updateDatalist(datalistId, value) {
        const datalist = document.getElementById(datalistId);
        if (!datalist || !value) return;
        const existingOptions = Array.from(datalist.options).map(opt => opt.value);
        if (!existingOptions.includes(value.toString())) {
            const option = document.createElement('option');
            option.value = value;
            datalist.appendChild(option);
        }
    }

    // --- CALCULATIONS & FORMATTING ---
    function getRawPrice(inputElement) {
        return parseFloat(inputElement.value.replace(/\./g, '')) || 0;
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('vi-VN').format(Math.round(value));
    }
    
    function formatNumber(value) {
        return new Intl.NumberFormat('vi-VN').format(value);
    }

    // --- NEW: Bidirectional Calculation Functions ---

    // Calculates TOTAL PRICE from unit price, quantity, etc.
    function calculateTotalFromInputs(e) {
        // Format the unit price input if it's the source of the event
        if (e && e.target.id === 'item-unit-price') {
            let value = e.target.value.replace(/\./g, '');
            e.target.value = isNaN(value) || value === '' ? '' : formatCurrency(value);
        }

        const width = parseFloat(inputRow.width.value) || 0;
        const height = parseFloat(inputRow.height.value) || 0;
        const unitPrice = getRawPrice(inputRow.unitPrice);
        const quantity = parseFloat(inputRow.quantity.value) || 0;
        const unit = inputRow.unit.value;

        const m2 = (width * height / 10000) * quantity;
        inputRow.m2.textContent = m2.toFixed(4);

        let totalPrice = 0;
        if (unit === 'm2') {
            totalPrice = m2 * unitPrice;
        } else {
            totalPrice = quantity * unitPrice;
        }
        inputRow.price.value = formatCurrency(totalPrice);
    }

    // Calculates UNIT PRICE from total price
    function calculateUnitFromTotal(e) {
        const unit = inputRow.unit.value;
        if (unit === 'm2') return; // This logic doesn't apply when unit is m2

        // Format the total price input itself
        let value = e.target.value.replace(/\./g, '');
        e.target.value = isNaN(value) || value === '' ? '' : formatCurrency(value);
        
        const totalPrice = parseFloat(value) || 0;
        const quantity = parseFloat(inputRow.quantity.value) || 0;

        if (quantity > 0) {
            const unitPrice = totalPrice / quantity;
            inputRow.unitPrice.value = formatCurrency(unitPrice);
        } else {
            inputRow.unitPrice.value = '0'; // Avoid division by zero
        }
    }

    function handleUnitChange() {
        if (inputRow.unit.value === 'khác') {
            inputRow.unitOther.classList.remove('hidden');
            inputRow.unitOther.focus();
        } else {
            inputRow.unitOther.classList.add('hidden');
            inputRow.unitOther.value = '';
        }

        // Toggle readonly state of total price input
        if (inputRow.unit.value === 'm2') {
            inputRow.price.setAttribute('readonly', true);
        } else {
            inputRow.price.removeAttribute('readonly');
        }
        
        // Recalculate everything based on the new unit
        calculateTotalFromInputs();
    }

    function calculateAndDisplayTotals() {
        const subtotal = helperItems.reduce((sum, item) => sum + item.totalPrice, 0);
        const totalVat = helperItems.reduce((sum, item) => {
            const vatAmount = item.totalPrice * (item.vat / 100);
            return sum + vatAmount;
        }, 0);
        const grandTotal = subtotal + totalVat;

        totalsDisplay.subtotal.textContent = formatCurrency(subtotal);
        totalsDisplay.vat.textContent = formatCurrency(totalVat);
        totalsDisplay.grandtotal.textContent = formatCurrency(grandTotal);
    }

    // --- CRUD OPERATIONS for Helper Table ---
    function handleAddOrUpdateItem() {
        const unitValue = inputRow.unit.value === 'khác' ? inputRow.unitOther.value.trim() : inputRow.unit.value;
        const nameValue = inputRow.name.value.trim();
        const unitPriceValue = inputRow.unitPrice.value;

        if (nameValue === '' || unitValue === '' || (parseFloat(inputRow.quantity.value) || 0) <= 0) {
            alert('Vui lòng nhập Hạng mục, ĐVT và Số lượng hợp lệ.');
            return;
        }

        if (nameValue) {
            updateDatalist('item-name-history', nameValue);
        }
        if (unitPriceValue && getRawPrice(inputRow.unitPrice) > 0) {
            updateDatalist('item-price-history', unitPriceValue);
        }

        const quantity = parseFloat(inputRow.quantity.value) || 0;
        const width = parseFloat(inputRow.width.value) || 0;
        const height = parseFloat(inputRow.height.value) || 0;
        const unitPrice = getRawPrice(inputRow.unitPrice);
        const m2 = (width * height / 10000) * quantity;

        let finalTotalPrice;
        if (unitValue === 'm2') {
            finalTotalPrice = m2 * unitPrice;
        } else {
            finalTotalPrice = quantity * unitPrice;
        }

        const itemData = {
            name: nameValue,
            spec: inputRow.spec.value.trim(),
            width: width,
            height: height,
            unit: unitValue,
            unitPrice: unitPrice,
            quantity: quantity,
            vat: parseFloat(inputRow.vat.value) || 0,
            m2: m2,
            totalPrice: finalTotalPrice
        };
        
        if (editingItemId !== null) {
            const itemIndex = helperItems.findIndex(item => item.id === editingItemId);
            if (itemIndex > -1) {
                helperItems[itemIndex] = { ...helperItems[itemIndex], ...itemData };
            }
            editingItemId = null;
        } else {
            const newItem = { id: Date.now(), stt: helperItems.length + 1, ...itemData };
            helperItems.push(newItem);
        }

        updateSTT();
        renderHelperTable();
        calculateAndDisplayTotals();
        resetInputRow();
    }

    function startEditingItem(itemId) {
        const item = helperItems.find(i => i.id === itemId);
        if (!item) return;

        editingItemId = itemId;
        inputRow.name.value = item.name;
        inputRow.width.value = item.width;
        inputRow.height.value = item.height;
        inputRow.quantity.value = item.quantity;
        inputRow.spec.value = item.spec;
        inputRow.vat.value = item.vat;
        inputRow.unitPrice.value = formatCurrency(item.unitPrice);
        inputRow.price.value = formatCurrency(item.totalPrice); // Set total price

        if (['m2', 'cái', 'bộ', 'gói', 'tấm', 'cuộn'].includes(item.unit)) {
            inputRow.unit.value = item.unit;
            inputRow.unitOther.classList.add('hidden');
        } else {
            inputRow.unit.value = 'khác';
            inputRow.unitOther.classList.remove('hidden');
            inputRow.unitOther.value = item.unit;
        }
        
        // Set readonly state based on loaded item's unit
        if (item.unit === 'm2') {
            inputRow.price.setAttribute('readonly', true);
        } else {
            inputRow.price.removeAttribute('readonly');
        }
        
        calculateTotalFromInputs(); // Recalculate m2 display
        inputRow.name.focus();
        closeActionMenu();
    }
    
    function deleteItem(itemId) {
        if (confirm('Bạn có chắc chắn muốn xóa mục này?')) {
            helperItems = helperItems.filter(item => item.id !== itemId);
            updateSTT();
            renderHelperTable();
            calculateAndDisplayTotals();
            if (editingItemId === itemId) {
                resetInputRow(); // Reset if the deleted item was being edited
            }
        }
        closeActionMenu();
    }

    function resetInputRow(isInitial = false) {
        if (isInitial) {
            inputRow.name.value = '';
            inputRow.unitPrice.value = '0';
        }
        
        inputRow.width.value = '0';
        inputRow.height.value = '0';
        inputRow.quantity.value = '1';
        inputRow.spec.value = '';
        inputRow.vat.value = '0';
        inputRow.unit.value = 'm2';
        inputRow.unitOther.classList.add('hidden');
        inputRow.unitOther.value = '';
        inputRow.price.value = '0';
        inputRow.price.setAttribute('readonly', true); // Default to readonly

        calculateTotalFromInputs();
        
        inputRow.stt.textContent = helperItems.length + 1;
        editingItemId = null;
        
        if (!isInitial) {
            inputRow.name.focus();
            inputRow.name.select();
        } else {
            inputRow.name.focus();
        }
    }
    
    function updateSTT() {
        helperItems.forEach((item, index) => {
            item.stt = index + 1;
        });
    }

    // --- Action Menu ---
    function showActionMenu(targetCell, itemId) {
        closeActionMenu();
        const menu = document.createElement('div');
        menu.className = 'action-menu';
        menu.innerHTML = `<button class="btn btn-secondary btn-sm edit-btn">Sửa</button><button class="btn btn-danger btn-sm delete-btn">Xóa</button>`;
        menu.querySelector('.edit-btn').addEventListener('click', () => startEditingItem(itemId));
        menu.querySelector('.delete-btn').addEventListener('click', () => deleteItem(itemId));
        
        document.body.appendChild(menu);
        const rect = targetCell.getBoundingClientRect();
        menu.style.top = `${rect.top + window.scrollY}px`;
        menu.style.left = `${rect.left + window.scrollX - menu.offsetWidth - 5}px`;
    }

    function closeActionMenu() {
        const existingMenu = document.querySelector('.action-menu');
        if (existingMenu) {
            existingMenu.remove();
        }
    }

    // --- RENDERING ---
    function renderHelperTable() {
        helperBody.innerHTML = '';
        helperItems.forEach(item => {
            const row = document.createElement('tr');
            row.className = 'bg-white hover:bg-gray-50';
            row.dataset.id = item.id;
            row.innerHTML = `
                <td class="stt-cell" data-id="${item.id}">${item.stt}</td>
                <td>${item.name}</td>
                <td>${item.width}</td>
                <td>${item.height}</td>
                <td>${formatNumber(item.quantity)}</td>
                <td>${item.m2.toFixed(4)}</td>
                <td>${item.unit}</td>
                <td>${formatCurrency(item.unitPrice)}</td>
                <td>${formatCurrency(item.totalPrice)}</td>
                <td>${item.spec}</td>
                <td>${item.vat}%</td>
            `;
            helperBody.appendChild(row);
        });
        inputRow.stt.textContent = helperItems.length + 1;
    }

    // --- QUOTE GENERATION & ACTIONS ---
    function generateQuote() {
        if (helperItems.length === 0) {
            alert('Vui lòng thêm ít nhất một mục vào bảng chi tiết trước khi tạo báo giá.');
            return;
        }

        const quoteNumber = document.getElementById('final-quote-number').value;
        document.getElementById('quote-number-display').textContent = `Số: ${quoteNumber}-25/BG-ĐN`;
        
        const mainQuoteBody = document.getElementById('main-quote-body');
        mainQuoteBody.innerHTML = '';
        helperItems.forEach((item, index) => {
            const finalUnitPrice = item.unit === 'm2' ? item.unitPrice : (item.quantity > 0 ? item.totalPrice / item.quantity : 0);
            const row = document.createElement('tr');
            // MODIFIED: All table cells are now center-aligned
            row.innerHTML = `
                <td class="text-center">${index + 1}</td>
                <td class="text-center">${item.name}</td>
                <td class="text-center">${formatNumber(item.width)}</td>
                <td class="text-center">${formatNumber(item.height)}</td>
                <td class="text-center">${item.spec}</td>
                <td class="text-center">${item.unit}</td>
                <td class="text-center">${formatCurrency(finalUnitPrice)}</td>
                <td class="text-center">${formatNumber(item.quantity)}</td>
                <td class="text-center">${formatCurrency(item.totalPrice)}</td>
            `;
            mainQuoteBody.appendChild(row);
        });

        const subtotal = helperItems.reduce((sum, item) => sum + item.totalPrice, 0);
        const totalVat = helperItems.reduce((sum, item) => sum + (item.totalPrice * (item.vat / 100)), 0);
        const grandTotal = subtotal + totalVat;

        quoteTotalsDisplay.subtotal.textContent = formatCurrency(subtotal);
        quoteTotalsDisplay.vat.textContent = formatCurrency(totalVat);
        quoteTotalsDisplay.grandtotal.textContent = formatCurrency(grandTotal);

        quotationOutput.classList.remove('hidden');
        quotationOutput.scrollIntoView({ behavior: 'smooth' });
    }

    function toggleQuoteEditMode() {
        const isEditing = toggleEditModeBtn.dataset.editing === 'true';
        const elements = document.querySelectorAll('.manual-edit');
        
        if (isEditing) {
            elements.forEach(el => {
                el.contentEditable = 'false';
                el.classList.remove('editable-text');
            });
            toggleEditModeBtn.textContent = 'Chỉnh Sửa';
            toggleEditModeBtn.dataset.editing = 'false';
            toggleEditModeBtn.classList.replace('btn-secondary', 'btn-warning');
        } else {
            elements.forEach(el => {
                el.contentEditable = 'true';
                el.classList.add('editable-text');
            });
            toggleEditModeBtn.textContent = 'Lưu thay đổi';
            toggleEditModeBtn.dataset.editing = 'true';
            toggleEditModeBtn.classList.replace('btn-warning', 'btn-secondary');
        }
    }
    
    function downloadQuoteAsPDF() {
        if (toggleEditModeBtn.dataset.editing === 'true') {
            toggleQuoteEditMode();
        }
        const element = document.getElementById('quotation-paper');
        const quoteNumber = document.getElementById('final-quote-number').value;
        const opt = {
          margin:       [0.2, 0.2, 0.2, 0.2],
          filename:     `BaoGia_${quoteNumber}.pdf`,
          image:        { type: 'jpeg', quality: 0.98 },
          html2canvas:  { scale: 2, useCORS: true },
          jsPDF:        { unit: 'in', format: 'a4', orientation: 'portrait' }
        };
        html2pdf().from(element).set(opt).save();
    }

    initialize();
});
</script>

</body>
</html>
